---
title: "Make Facility Type Viewer"
output: html_notebook
---

# Overhead
```{r overhead, include = FALSE}
packages_vector <- c("tidyverse",
                     "jsonlite",
                     "sf")

need_to_install <- packages_vector[!(packages_vector %in% installed.packages()[,"Package"])]

if (length(need_to_install)) install.packages(need_to_install)

for (package in packages_vector) {
  library(package, character.only = TRUE)
}

```

# Remote I/O
```{r remote-io}
interim_dir <- "../../data/interim/"
processed_dir <- "../../data/processed/" 

links_file_name <- paste0(interim_dir, "step5_tidy_roadway/link.json")
shape_file_name <- paste0(interim_dir, "step5_tidy_roadway/shape.geojson")
conflation_file_name <- paste0(interim_dir, "conflation_review_for_tableau.csv")

output_file_name <- paste0(interim_dir, "facility-type-viewer.geojson")
output_residential_file_name <- paste0(interim_dir, "facility-type-viewer-residential.geojson")
```

# Parameters
```{r parameters}
frc_dict_df <- tibble(code = seq(-1, 8),
                      label = c("Not Applicable",
                                "Motorway, Freeway, or Other Major Road",
                                "Major Road Less Important than a Motorway",
                                "Other Major Road",
                                "Secondary Road",
                                "Local Connecting Road",
                                "Local Road of High Importance",
                                "Local Road",
                                "Local Road of Minor Importance",
                                "Other Road"))

ft_dict_df <- tibble(code = seq(0, 7),
                     label = c("Connector",
                               "Freeway to Freeway",
                               "Freeway",
                               "Expressway",
                               "Collector",
                               "Ramp",
                               "Special Facility",
                               "Major Arterial"))
```


# Data Reads
```{r read}
shapes_sf <- st_read(shape_file_name)
links_df <- read_json(links_file_name, simplifyVector = TRUE)
conflation_df <- read_csv(conflation_file_name, col_types = cols(.default = col_character()))
```

# Reductions 
```{r reductions}
osm_lanes_df <- links_df  %>%
  filter(drive_access == 1) %>%
  select(shstReferenceId, lanes) %>%
  rowwise() %>%
  mutate(lanes_str = paste(unlist(lanes), collapse = "--")) %>%
  ungroup() %>%
  select(-lanes) %>%
  mutate(
    min_lanes = case_when (
      str_detect(lanes_str, "1") ~ 1L,
      str_detect(lanes_str, "2") ~ 2L,
      str_detect(lanes_str, "3") ~ 3L,
      str_detect(lanes_str, "4") ~ 4L,
      str_detect(lanes_str, "5") ~ 5L,
      str_detect(lanes_str, "6") ~ 6L,
      str_detect(lanes_str, "7") ~ 7L,
      str_detect(lanes_str, "8") ~ 8L,
      str_detect(lanes_str, "9") ~ 9L,
      str_detect(lanes_str, "10") ~ 10L,
      str_detect(lanes_str, "11") ~ 11L,
      str_detect(lanes_str, "12") ~ 12L,
      TRUE ~ as.integer(NA)
    )
  ) %>%
  mutate(max_lanes = as.integer(NA)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "1"), 1L, max_lanes)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "2"), 2L, max_lanes)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "3"), 3L, max_lanes)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "4"), 4L, max_lanes)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "5"), 5L, max_lanes)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "6"), 6L, max_lanes)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "7"), 7L, max_lanes)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "8"), 8L, max_lanes)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "9"), 9L, max_lanes)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "10"), 10L, max_lanes)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "11"), 11L, max_lanes)) %>%
  mutate(max_lanes = if_else(str_detect(lanes_str, "12"), 12L, max_lanes)) %>%
  select(shstReferenceId, osm_min_lanes = min_lanes, osm_max_lanes = max_lanes)

osm_names_df <- links_df  %>%
  filter(drive_access == 1) %>%
  select(shstReferenceId, name) %>%
  rowwise() %>%
  mutate(name_list = paste(unlist(name), collapse = "/")) %>%
  ungroup() %>%
  select(-name) %>%
  separate(name_list, 
           into = sprintf("%02d", seq(1:5)), 
           sep = "/",
           remove = TRUE,
           extra = "drop",
           fill = "right") %>%
  pivot_longer(cols = -c(shstReferenceId),
               names_to = "index",
               values_to = "name") %>%
  select(-index) %>%
  filter(!is.na(name)) %>%
  filter(name != "nan") %>%
  filter(name != "") %>%
  distinct(shstReferenceId, name) %>%
  group_by(shstReferenceId) %>%
  mutate(index = row_number()) %>%
  ungroup() %>%
  pivot_wider(id_cols = shstReferenceId,
              names_prefix = "name_",
              names_from = index,
              values_from = name) %>%
  mutate(name = if_else(is.na(name_2), name_1, paste0(name_1, "/", name_2))) %>%
  mutate(name = if_else(is.na(name_3), name, paste0(name, "/", name_3))) %>%
  select(shstReferenceId, name)

join_df <- conflation_df %>%
  select(shstReferenceId, 
         marin_ft = TM2Marin_FT,
         marin_assign = TM2Marin_ASSIGNABLE,
         marin_lanes = TM2Marin_LANES,
         tm2_ft = TM2_FT,
         tm2_lanes = TM2_LANES,
         tm2_assign = TM2_ASSIGNABLE,
         sfcta_ft = sfcta_FT,
         sfcta_LANE_AM, 
         sfcta_LANE_OP, 
         sfcta_LANE_PM) %>%
  mutate_at(., c("marin_ft", "marin_assign", "marin_lanes",
                 "tm2_ft", "tm2_lanes", "tm2_assign",
                 "sfcta_ft", "sfcta_LANE_AM", "sfcta_LANE_OP", "sfcta_LANE_PM"), as.integer) %>%
  mutate(sfcta_min_lanes = if_else(is.na(sfcta_LANE_OP), as.integer(NA), pmin(sfcta_LANE_AM, sfcta_LANE_OP, sfcta_LANE_PM))) %>%
  mutate(sfcta_max_lanes = if_else(is.na(sfcta_LANE_OP), as.integer(NA), pmax(sfcta_LANE_AM, sfcta_LANE_OP, sfcta_LANE_PM))) %>%
  select(-sfcta_LANE_AM, -sfcta_LANE_OP, -sfcta_LANE_PM)

output_sf <- links_df %>%
  filter(drive_access == 1) %>%
  filter(!(roadway %in% c("service", "residential"))) %>%
  select(shstReferenceId, 
         FRC, 
         shstGeometryId, 
         tom_lanes = LANES, 
         osm_ft = roadway) %>%
  mutate(tom_lanes = as.integer(tom_lanes)) %>%
  left_join(., osm_lanes_df, by = c("shstReferenceId")) %>%
  left_join(., osm_names_df, by = c("shstReferenceId")) %>%
  left_join(., frc_dict_df, by = c("FRC" = "code")) %>%
  rename(tom_tom_ft = label) %>%
  left_join(., join_df, by = c("shstReferenceId")) %>%
  left_join(., shapes_sf, by = c("shstGeometryId" = "id")) %>%
  select(shstReferenceId, 
         name,
         osm_ft, 
         tom_tom_ft, 
         marin_ft,
         tm2_ft,
         sfcta_ft,
         osm_min_lanes, 
         osm_max_lanes, 
         tom_lanes,
         marin_lanes,
         tm2_lanes,
         sfcta_min_lanes,
         sfcta_max_lanes,
         geometry)

output_residential_sf <- links_df %>%
  filter(drive_access == 1) %>%
  filter(roadway %in% c("residential")) %>%
  select(shstReferenceId, 
         FRC, 
         shstGeometryId, 
         tom_lanes = LANES, 
         osm_ft = roadway) %>%
  mutate(tom_lanes = as.integer(tom_lanes)) %>%
  left_join(., osm_lanes_df, by = c("shstReferenceId")) %>%
  left_join(., osm_names_df, by = c("shstReferenceId")) %>%
  left_join(., frc_dict_df, by = c("FRC" = "code")) %>%
  rename(tom_tom_ft = label) %>%
  left_join(., join_df, by = c("shstReferenceId")) %>%
  left_join(., shapes_sf, by = c("shstGeometryId" = "id")) %>%
  select(shstReferenceId, 
         name,
         osm_ft, 
         tom_tom_ft, 
         marin_ft,
         tm2_ft,
         sfcta_ft,
         osm_min_lanes, 
         osm_max_lanes, 
         tom_lanes,
         marin_lanes,
         tm2_lanes,
         sfcta_min_lanes,
         sfcta_max_lanes,
         geometry)

```

# Write
```{r write}
st_write(output_sf, output_file_name, delete_dsn = TRUE)
st_write(output_residential_sf, output_residential_file_name, delete_dsn = TRUE)
```


