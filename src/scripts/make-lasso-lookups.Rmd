---
title: "Make Lasso Lookups"
output: html_notebook
---

# Overhead
```{r overhead, include = FALSE}
packages_vector <- c("tidyverse",
                     "arrow")

need_to_install <- packages_vector[!(packages_vector %in% installed.packages()[,"Package"])]

if (length(need_to_install)) install.packages(need_to_install)

for (package in packages_vector) {
  library(package, character.only = TRUE)
}

```

# Remote I/O
```{r remote-io}
interim_dir <- "../../data/interim/"
lasso_lookup_dir <- "../../../mtc-Lasso/mtc_data/lookups/"

links_file_name <- paste0(interim_dir, "step5_tidy_roadway/link.feather")

output_legacy_tm2_file_name <- paste0(lasso_lookup_dir, "legacy_tm2_attributes.csv")
output_tam_tm2_file_name <- paste0(lasso_lookup_dir, "tam_tm2_attributes.csv")
output_pems_file_name <- paste0(lasso_lookup_dir, "pems_attributes.csv")
output_sfcta_file_name <- paste0(lasso_lookup_dir, "sfcta_attributes.csv")
output_tomtom_file_name <- paste0(lasso_lookup_dir, "tomtom_attributes.csv")
```

# Parameters
```{r parameters}
frc_dict_df <- tibble(code = seq(-1, 8),
                      label = c("Not Applicable",
                                "Motorway, Freeway, or Other Major Road",
                                "Major Road Less Important than a Motorway",
                                "Other Major Road",
                                "Secondary Road",
                                "Local Connecting Road",
                                "Local Road of High Importance",
                                "Local Road",
                                "Local Road of Minor Importance",
                                "Other Road"))

ft_dict_df <- tibble(code = seq(0, 7),
                     label = c("Connector",
                               "Freeway to Freeway",
                               "Freeway",
                               "Expressway",
                               "Collector",
                               "Ramp",
                               "Special Facility",
                               "Major Arterial"))
```


# Data Reads
```{r read}
links_df <- read_feather(links_file_name)
```

# Reductions 
```{r reductions}
legacy_df <- links_df %>%
  filter(!is.na(TM2_A)) %>%
  select(shstReferenceId, 
         shstGeometryId,
         A_node = TM2_A,
         B_node = TM2_B,
         code = TM2_FT,
         lanes = TM2_LANES,
         assignable = TM2_ASSIGNABLE) %>%
  left_join(., ft_dict_df, by = c("code")) %>%
  rename(ft = label) %>%
  select(-code)

tam_df <- links_df %>%
  filter(!is.na(TM2Marin_A)) %>%
  select(shstReferenceId, 
         shstGeometryId,
         A_node = TM2Marin_A,
         B_node = TM2Marin_B,
         code = TM2Marin_FT,
         lanes = TM2Marin_LANES,
         assignable = TM2Marin_ASSIGNABLE) %>%
  left_join(., ft_dict_df, by = c("code")) %>%
  rename(ft = label) %>%
  select(-code)

# TODO: add and filter PeMS id 
pems_df <- links_df %>%
  select(shstReferenceId,
         shstGeometryId,
         contains("pems")) %>%
  mutate(pems_ft = as.character(NA)) %>%
  mutate(pems_ft = if_else(is.na(pems_lanes_FR), pems_ft, "Ramp")) %>%
  mutate(pems_ft = if_else(is.na(pems_lanes_OR), pems_ft, "Ramp")) %>%
  mutate(pems_ft = if_else(is.na(pems_lanes_FF), pems_ft, "Freeway to Freeway")) %>%
  mutate(pems_ft = if_else(is.na(pems_lanes_ML), pems_ft, "Freeway")) %>%
  mutate(pems_ft = if_else(is.na(pems_lanes_HV), pems_ft, "Freeway")) %>%
  mutate(pems_lanes = as.integer(NA)) %>%
  mutate(pems_lanes = if_else(is.na(pems_lanes_FR), pems_lanes, as.integer(pems_lanes_FR))) %>%
  mutate(pems_lanes = if_else(is.na(pems_lanes_OR), pems_lanes, as.integer(pems_lanes_OR))) %>%
  mutate(pems_lanes = if_else(is.na(pems_lanes_FF), pems_lanes, as.integer(pems_lanes_FF))) %>%
  mutate(pems_lanes = if_else(is.na(pems_lanes_ML), pems_lanes, as.integer(pems_lanes_ML))) %>%
  mutate(pems_lanes = if_else(is.na(pems_lanes_HV), pems_lanes, as.integer(pems_lanes_HV) + pems_lanes)) %>%
  select(-pems_lanes_FF, -pems_lanes_FR, -pems_lanes_HV, -pems_lanes_ML, -pems_lanes_OR) %>%
  rename(ft = pems_ft, lanes = pems_lanes) %>%
  filter(!is.na(lanes))
  
tom_df <- links_df %>%
  filter(!is.na(TM2Marin_A)) %>%
  select(shstReferenceId, 
         shstGeometryId,
         tom_id = tomtom_unique_id,
         F_JNCTID,
         T_JNCTID,
         code = tomtom_FRC,
         lanes = tomtom_lanes,
         tomtom_shieldnum,
         tomtom_rtedir) %>%
  left_join(., frc_dict_df, by = c("code")) %>%
  rename(ft = label) %>%
  select(-code) %>%
  mutate(name = paste0(tomtom_shieldnum, " ", tomtom_rtedir)) %>%
  select(-tomtom_shieldnum, -tomtom_rtedir)
  
sfcta_df <- links_df %>%
  filter(!is.na(sfcta_A)) %>%
  select(shstReferenceId, 
         shstGeometryId,
         A_node = sfcta_A,
         B_node = sfcta_B,
         lanes_am = sfcta_LANE_AM,
         lanes_md = sfcta_LANE_OP,
         lanes_pm = sfcta_LANE_PM,
         name = sfcta_STREETNAME)
  
```

# Write
```{r write}
write_csv(legacy_df, path = output_legacy_tm2_file_name)
write_csv(tam_df, path = output_tam_tm2_file_name)
write_csv(pems_df, path = output_pems_file_name)
write_csv(sfcta_df, path = output_sfcta_file_name)
write_csv(tom_df, path = output_tomtom_file_name)
```


