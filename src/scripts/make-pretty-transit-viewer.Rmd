---
title: "Make Pretty Transit Viewer"
output: html_notebook
---

# Overhead
```{r overhead, include = FALSE}
packages_vector <- c("tidyverse",
                     "arrow",
                     "lubridate",
                     "sf")

need_to_install <- packages_vector[!(packages_vector %in% installed.packages()[,"Package"])]

if (length(need_to_install)) install.packages(need_to_install)

for (package in packages_vector) {
  library(package, character.only = TRUE)
}

```

# Remote I/O
```{r remote-io}
interim_dir <- "../../data/interim/"
processed_dir <- "../../data/processed/" 

shape_file_name <- paste0(interim_dir, "simple_shape.RDS")
links_file_name <- paste0(interim_dir, "step6_gtfs/link.feather")
node_file_name <- paste0(interim_dir, "step6_gtfs/node.geojson")

output_file_name <- paste0(interim_dir, "transit_for_tableau.geojson")
```

# Parameters
```{r parameters}
VERSION <- "version_01"
```

# Data Reads
```{r read}
routes_df <- read_csv(paste0(interim_dir, "step6_gtfs/", "routes.txt"), col_types = "ccccciccccccccci")
freq_df <- read_csv(paste0(interim_dir, "step6_gtfs/", "frequencies.txt"), col_types = "iitt")
trips_df <- read_csv(paste0(interim_dir, "step6_gtfs/", "trips.txt"), col_types = "ccncnncccccccccccciii")
stops_df <- read_csv(paste0(interim_dir, "step6_gtfs/", "stops.txt"), col_types  = "ccddccnccnccccinci")
shapes_df <- read_csv(paste0(interim_dir, "step6_gtfs/", "shapes.txt"), col_types = "iinci")
stop_times_df <- read_csv(paste0(interim_dir, "step6_gtfs/", "stop_times.txt"), col_types = "tticncddcccccccccccii")

links_df <- read_feather(links_file_name)
shapes_sf <- readRDS(shape_file_name)
nodes_sf <- st_read(node_file_name)
```

# Helpers for Part 1
```{r helpers}
shapes_as_sf <- function(df) {
  # adapted from tidy transit
  
  list_of_line_tibbles <- split(df, df$shape_id)
  list_of_linestrings <- lapply(list_of_line_tibbles, shape_as_sf_linestring)
  
  shape_linestrings <- sf::st_sfc(list_of_linestrings, crs = 4326)
  
  shapes_sf <- sf::st_sf(shape_id = names(list_of_line_tibbles), geometry = shape_linestrings)
  shapes_sf$shape_id <- as.character(shapes_sf$shape_id)
  
  return(shapes_sf)
}

shape_as_sf_linestring <- function(df) {
  # as suggested by www.github.com/mdsumner via tidytransit

  m <- as.matrix(df[order(df$stop_sequence),
                    c("stop_lat", "stop_lon")])

  return(sf::st_linestring(m))
}
```

# Make Stop-to-stop Line Strings
```{r process-stops}
working_stops_df <- select(routes_df, agency_id, agency_raw_name, route_id, 
                          route_short_name, route_long_name) %>%
  left_join(select(trips_df, route_id, service_id, trip_id, trip_headsign, direction_id, shape_id),
            ., 
            by = c("route_id")) %>%
  left_join(., freq_df, by = c("trip_id")) %>%
  left_join(select(stop_times_df, trip_id, stop_id, stop_sequence), ., by = c("trip_id")) %>%
  left_join(., select(stops_df, stop_id, stop_name, stop_lat, stop_lon), by = c("stop_id")) %>%
  mutate(time_period = case_when(
    hour(start_time) == 3 ~ "Early Morning",
    hour(start_time) == 6 ~ "Morning Commute",
    hour(start_time) == 10 ~ "Midday",
    hour(start_time) == 15 ~ "Evening Commute",
    hour(start_time) == 19 ~ "Evening/Night",
    TRUE ~ "Missing"
  )) %>%
  select(-start_time, -end_time) %>%
  arrange(agency_id, service_id, route_id, time_period, direction_id, stop_sequence)

working_shapes_sf <- shapes_as_sf(working_stops_df)

output_stops_sf <- working_stops_df %>%
  distinct(agency_id, agency_raw_name, route_id, route_short_name, route_long_name,
           trip_id, service_id, trip_headsign, direction_id, shape_id,
           time_period, headway_secs) %>%
  mutate(summary = "stops") %>%
  left_join(mutate(working_shapes_sf, shape_id = as.integer(shape_id)), ., by = c("shape_id"))

```

# Make True Shapes of Segments
```{r process-shapes}
join_link_shape_sf <- links_df %>%
  select(shstGeometryId, A, B) %>%
  left_join(., shapes_sf, by = c("shstGeometryId"))

working_shapes_df <- select(routes_df, agency_id, agency_raw_name, route_id, 
                           route_short_name, route_long_name) %>%
  left_join(select(trips_df, route_id, service_id, trip_id, trip_headsign, direction_id, shape_id),
            ., by = c("route_id")) %>%
  left_join(., freq_df, by = c("trip_id")) %>%
  left_join(., 
            select(shapes_df, shape_id, shape_pt_sequence, shape_model_node_id), 
            by = c("shape_id")) %>%
  group_by(route_id, service_id, trip_id, direction_id) %>%
  mutate(join_A = shape_model_node_id) %>%
  mutate(join_B = lead(shape_model_node_id)) %>%
  ungroup() %>%
  filter(!is.na(join_B)) %>%
  left_join(., join_link_shape_sf, by = c("join_A" = "A", "join_B" = "B")) %>%
  mutate(time_period = case_when(
    hour(start_time) == 3 ~ "Early Morning",
    hour(start_time) == 6 ~ "Morning Commute",
    hour(start_time) == 10 ~ "Midday",
    hour(start_time) == 15 ~ "Evening Commute",
    hour(start_time) == 19 ~ "Evening/Night",
    TRUE ~ "Missing"
  )) %>%
  select(-start_time, -end_time)

pretty_shapes_sf <- working_shapes_df %>%
  st_as_sf(., crs = 4326)
  
working_shapes_sf <- working_shapes_df %>%
  select(shape_id, geometry) %>%
  st_as_sf(., crs = 4326) %>%
  group_by(shape_id) %>%
  summarise(geometry = st_combine(geometry))

output_shapes_sf <- working_shapes_df %>%
  distinct(agency_id, agency_raw_name, route_id, route_short_name, route_long_name,
           trip_id, service_id, trip_headsign, direction_id, shape_id,
           time_period, headway_secs) %>%
  mutate(summary = "shape") %>%
  left_join(mutate(working_shapes_sf, shape_id = as.integer(shape_id)), ., by = c("shape_id"))

```

# Write
```{r write}
st_write(pretty_shapes_sf, output_file_name, delete_dsn = TRUE)
```

